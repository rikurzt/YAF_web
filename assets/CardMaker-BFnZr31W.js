import{d as B,g as _,k as J,w as j,i as q,l as V,o as L,c as F,b as a,_ as N,m as $,v as E,p as G,a as K,e as Q,C as Z}from"./index-CeNMSRc_.js";const S={class:"canvas-container"},z=B({__name:"ImageCapture",props:{title:{},subtitle:{},image:{}},setup(W,{expose:C}){const o=W,n=_(null),u=_(null),r=_(null),X=J(()=>"/YAF_web/img/card_base.png"),y=e=>new Promise((t,l)=>{const i=new Image;i.onload=()=>t(i),i.onerror=l,i.crossOrigin="anonymous",i.src=e}),s=(e,t,l,i,g,h,c,H="left",p="top")=>{e.save(),e.beginPath(),e.rect(l,i,g,h),e.clip(),e.font=`bold ${c}px "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif`,e.fillStyle="#2c3e50",e.shadowColor="rgba(255, 255, 255, 0.9)",e.shadowBlur=3,e.shadowOffsetX=2,e.shadowOffsetY=2;const d=8,v=l+d,w=i+d,T=g-d*2,M=h-d*2,R=t.split(""),Y=[];let b="";for(let f=0;f<R.length;f++){const k=b+R[f];e.measureText(k).width>T&&b!==""?(Y.push(b),b=R[f]):b=k}b&&Y.push(b);const D=c*1.2,O=Y.length*D;let U=w;p==="middle"?U=w+(M-O)/2:p==="bottom"&&(U=w+M-O),Y.forEach((f,k)=>{let I=v;if(H==="center"){const x=e.measureText(f).width;I=v+(T-x)/2}else if(H==="right"){const x=e.measureText(f).width;I=v+T-x}const P=U+k*D+c;e.fillText(f,I,P)}),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.restore()},m=async e=>{const t=e.getContext("2d");if(t){t.clearRect(0,0,800,800);try{if(!u.value)try{u.value=await y(X.value),console.log("底圖載入成功")}catch(l){console.warn("底圖載入失敗:",l)}if(u.value){const l=u.value.width/u.value.height;let i=800,g=800,h=0,c=0;l>1?(g=800/l,c=(800-g)/2):(i=800*l,h=(800-i)/2),t.drawImage(u.value,h,c,i,g)}if(o.image){if(!r.value||r.value.src!==o.image)try{r.value=await y(o.image),console.log("用戶圖片載入成功")}catch(l){console.warn("用戶圖片載入失敗:",l),r.value=null}if(r.value){t.save(),t.beginPath(),t.rect(360,34.4,400,680),t.clip();const c=r.value.width/r.value.height,H=400/680;let p,d,v,w;c>H?(d=680,p=d*c,v=360-(p-400)/2,w=34.4):(p=400,d=p/c,v=360,w=34.4-(d-680)/2),t.drawImage(r.value,v,w,p,d),t.restore()}}else r.value=null;o.title&&s(t,o.title,80,384,200,80,28,"center","middle"),o.subtitle&&s(t,o.subtitle,80,568,200,160,20,"left","middle")}catch(l){console.error("Canvas 渲染失敗:",l)}}};return j([()=>o.title,()=>o.subtitle,()=>o.image],async()=>{await V(),n.value&&await m(n.value)},{immediate:!1}),q(async()=>{await V(),n.value&&await m(n.value)}),C({capture:async()=>{if(!n.value){console.error("previewCanvas 不存在");return}try{console.log("開始下載圖片...");const e=n.value.toDataURL("image/png",1);if(console.log("生成 dataURL 長度:",e.length),e.length<1e3)throw new Error("生成的圖片數據太小");const t=document.createElement("a");t.download=`card-image-${Date.now()}.png`,t.href=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),console.log("圖片下載完成！")}catch(e){console.error("下載圖片失敗:",e),alert("圖片下載失敗，請檢查控制台錯誤信息")}}}),(e,t)=>(L(),F("div",S,[a("canvas",{ref_key:"previewCanvas",ref:n,class:"preview-canvas",width:"800",height:"800"},null,512)]))}}),ee=N(z,[["__scopeId","data-v-80c67e09"]]),te={class:"container-fluid py-4"},ae={class:"row g-3"},se={class:"col-lg-4 col-md-5 mb-3"},le={class:"card h-100"},oe={class:"card-body"},ie={class:"mb-3"},ne={class:"mb-3"},re={class:"mb-3"},ce={class:"col-lg-8 col-md-7"},de={class:"card h-100 p-1"},ue={class:"card-body text-center p-2"},me={class:"preview-wrapper"},ge=B({__name:"CardMaker_Componment",setup(W){const C=_(null),o=_(""),n=_(""),u=_(null),r=y=>{var A;const m=(A=y.target.files)==null?void 0:A[0];if(m){const e=new FileReader;e.onload=()=>{u.value=e.result},e.readAsDataURL(m)}},X=()=>{C.value?C.value.capture():console.warn("ImageCaptureRef not ready")};return(y,s)=>(L(),F("div",te,[a("div",ae,[a("div",se,[a("div",le,[a("div",oe,[s[6]||(s[6]=a("h5",{class:"card-title text-center mb-4"},"圖片內容設定",-1)),a("div",ie,[s[2]||(s[2]=a("label",{class:"form-label"},"暱稱",-1)),$(a("input",{type:"text",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=m=>o.value=m),placeholder:"輸入標題"},null,512),[[E,o.value]])]),a("div",ne,[s[3]||(s[3]=a("label",{class:"form-label"},"留言內容",-1)),$(a("input",{type:"text",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=m=>n.value=m),placeholder:"輸入副標題"},null,512),[[E,n.value]])]),a("div",re,[s[4]||(s[4]=a("label",{class:"form-label"},"上傳圖片",-1)),a("input",{type:"file",class:"form-control",onChange:r,accept:"image/*"},null,32)]),a("button",{class:"btn btn-primary w-100 btn-lg",onClick:X},s[5]||(s[5]=[a("i",{class:"fas fa-download me-2"},null,-1),G("下載圖片 ")]))])])]),a("div",ce,[a("div",de,[a("div",ue,[s[7]||(s[7]=a("h5",{class:"card-title mb-3"},"圖片預覽",-1)),a("div",me,[K(ee,{ref_key:"ImageCaptureRef",ref:C,title:o.value,subtitle:n.value,image:u.value},null,8,["title","subtitle","image"])])])])])])]))}}),he=N(ge,[["__scopeId","data-v-a4a7cfd5"]]),fe=B({__name:"CardMaker",setup(W){return(C,o)=>(L(),Q(Z,{title:"預定圖製作器",content:he,"is-component":!0,disable:!0,"force-visible":!0}))}});export{fe as default};
