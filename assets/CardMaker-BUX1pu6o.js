import{d as B,J as c,M as J,O as K,K as Q,P as $,o as R,c as W,b as s,_ as F,Q as M,R as S,S as N,f as q,T as j,a as G,e as Z,C as ee}from"./index-BpA5T04r.js";const te={class:"canvas-container"},oe=B({__name:"ImageCapture",props:{title:{},subtitle:{},image:{},imageOffsetX:{},category:{}},setup(A,{expose:p}){const r=A,u=c(null),h=c(null),d=c(null),k=c({width:800,height:800}),x=J(()=>"/YAF_web/img/card_base.png"),v=t=>new Promise((a,e)=>{const o=new Image;o.onload=()=>a(o),o.onerror=e,o.crossOrigin="anonymous",o.src=t}),T=(t,a,e,o,i,l,n,m="left",O="top")=>{t.save(),t.beginPath(),t.rect(e,o,i,l),t.clip(),t.font=`bold ${n}px "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif`,t.fillStyle="#2c3e50",t.shadowColor="rgba(255, 255, 255, 0.9)",t.shadowBlur=3,t.shadowOffsetX=2,t.shadowOffsetY=2;const g=8,f=e+g,b=o+g,y=i-g*2,X=l-g*2,_=a.split(""),H=[];let C="";for(let w=0;w<_.length;w++){const U=C+_[w];t.measureText(U).width>y&&C!==""?(H.push(C),C=_[w]):C=U}C&&H.push(C);const L=n*1.2,D=H.length*L;let V=b;O==="middle"?V=b+(X-D)/2:O==="bottom"&&(V=b+X-D),H.forEach((w,U)=>{let Y=f;if(m==="center"){const P=t.measureText(w).width;Y=f+(y-P)/2}else if(m==="right"){const P=t.measureText(w).width;Y=f+y-P}const z=V+U*L+n;t.fillText(w,Y,z)}),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,t.restore()},I=async t=>{const a=t.getContext("2d");if(a)try{if(!h.value)try{h.value=await v(x.value),console.log("底圖載入成功");const e=h.value.width,o=h.value.height,i=800,l=Math.min(i/e,i/o),n=Math.round(e*l),m=Math.round(o*l);t.width=n,t.height=m,k.value={width:n,height:m},console.log(`Canvas尺寸調整為: ${n}x${m}`)}catch(e){console.warn("底圖載入失敗:",e)}if(a.clearRect(0,0,t.width,t.height),h.value&&a.drawImage(h.value,0,0,t.width,t.height),r.image){if(!d.value||d.value.src!==r.image)try{d.value=await v(r.image),console.log("用戶圖片載入成功")}catch(e){console.warn("用戶圖片載入失敗:",e),d.value=null}if(d.value){const e=t.width*.447,o=t.height*.076,i=t.width*.342,l=t.height*.763;a.save(),a.beginPath();const n=34;a.moveTo(e+n,o),a.lineTo(e+i-n,o),a.quadraticCurveTo(e+i,o,e+i,o+n),a.lineTo(e+i,o+l-n),a.quadraticCurveTo(e+i,o+l,e+i-n,o+l),a.lineTo(e+n,o+l),a.quadraticCurveTo(e,o+l,e,o+l-n),a.lineTo(e,o+n),a.quadraticCurveTo(e,o,e+n,o),a.closePath(),a.clip();const m=d.value.width/d.value.height,O=i/l;let g,f,b,y;if(m>O){f=l,g=f*m;const X=r.imageOffsetX/100,_=(g-i)/2;b=e-_+_*X,y=o}else g=i,f=g/m,b=e,y=o-(f-l)/2;a.drawImage(d.value,b,y,g,f),a.restore()}}else d.value=null;if(r.title){const e=t.width*.025,o=t.height*.52,i=t.width*.35,l=t.height*.08,n=Math.round(t.width*.03);T(a,r.title,e,o,i,l,n,"center","middle")}if(r.category){const e=t.width*.025,o=t.height*.325,i=t.width*.35,l=t.height*.06,n=Math.round(t.width*.04);T(a,r.category,e,o,i,l,n,"center","middle")}if(r.subtitle){const e=t.width*.025,o=t.height*.7,i=t.width*.35,l=t.height*.22,n=Math.round(t.width*.025);T(a,r.subtitle,e,o,i,l,n,"left","top")}}catch(e){console.error("Canvas 渲染失敗:",e)}};return K([()=>r.title,()=>r.subtitle,()=>r.image,()=>r.imageOffsetX,()=>r.category],async()=>{await $(),u.value&&await I(u.value)},{immediate:!1}),Q(async()=>{await $(),u.value&&await I(u.value)}),p({capture:async()=>{if(!u.value){console.error("previewCanvas 不存在");return}try{console.log("開始下載圖片...");const t=u.value.toDataURL("image/png",1);if(console.log("生成 dataURL 長度:",t.length),t.length<1e3)throw new Error("生成的圖片數據太小");const a=document.createElement("a");a.download=`card-image-${Date.now()}.png`,a.href=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),console.log("圖片下載完成！")}catch(t){console.error("下載圖片失敗:",t),alert("圖片下載失敗，請檢查控制台錯誤信息")}}}),(t,a)=>(R(),W("div",te,[s("canvas",{ref_key:"previewCanvas",ref:u,class:"preview-canvas"},null,512)]))}}),ae=F(oe,[["__scopeId","data-v-35f5fbaa"]]),se={class:"container-fluid py-4"},le={class:"row g-3"},ie={class:"col-lg-4 col-md-5 mb-3"},ne={class:"card h-100"},re={class:"card-body"},de={class:"mb-3"},ce={class:"mb-3"},ue={class:"mb-3"},he={class:"d-flex gap-3"},me={class:"form-check"},ge={class:"form-check"},fe={class:"mb-3"},pe={key:0,class:"mb-3"},ve={class:"d-flex align-items-center gap-3"},we={class:"col-lg-8 col-md-7"},be={class:"card h-100 p-1"},ye={class:"card-body text-center p-2"},Ce={class:"preview-wrapper"},_e={key:0,class:"modal fade show d-block",tabindex:"-1",style:{"background-color":"rgba(0, 0, 0, 0.8)"}},ke={class:"modal-dialog modal-dialog-centered modal-xl"},xe=B({__name:"CardMaker_Componment",setup(A){const p=c(null),r=c("雲緣起"),u=c(null),h=c(0),d=c("COSER"),k=c(""),x=c(!1),v=c(null),T=a=>{var i;const o=(i=a.target.files)==null?void 0:i[0];if(o){const l=new FileReader;l.onload=()=>{u.value=l.result},l.readAsDataURL(o)}},I=()=>{p.value?p.value.capture():console.warn("ImageCaptureRef not ready")},E=async()=>{var a;if(x.value=!0,await $(),v.value&&p.value){const e=(a=p.value.$refs)==null?void 0:a.previewCanvas;if(e){v.value.width=800,v.value.height=800;const o=v.value.getContext("2d");o&&(o.clearRect(0,0,800,800),o.drawImage(e,0,0,e.width,e.height,0,0,800,800))}}},t=()=>{x.value=!1};return(a,e)=>(R(),W("div",se,[s("div",le,[s("div",ie,[s("div",ne,[s("div",re,[e[14]||(e[14]=s("h5",{class:"card-title text-center mb-4"},"圖片內容設定",-1)),s("div",de,[e[5]||(e[5]=s("label",{class:"form-label"},"暱稱",-1)),M(s("input",{type:"text",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=o=>r.value=o),placeholder:"輸入標題"},null,512),[[S,r.value]])]),s("div",ce,[e[6]||(e[6]=s("label",{class:"form-label"},"留言內容",-1)),M(s("input",{type:"text",class:"form-control","onUpdate:modelValue":e[1]||(e[1]=o=>k.value=o),placeholder:"輸入副標題"},null,512),[[S,k.value]])]),s("div",ue,[e[9]||(e[9]=s("label",{class:"form-label"},"類別",-1)),s("div",he,[s("div",me,[M(s("input",{class:"form-check-input",type:"radio",name:"category",id:"coser",value:"COSER","onUpdate:modelValue":e[2]||(e[2]=o=>d.value=o)},null,512),[[N,d.value]]),e[7]||(e[7]=s("label",{class:"form-check-label",for:"coser"}," COSER ",-1))]),s("div",ge,[M(s("input",{class:"form-check-input",type:"radio",name:"category",id:"photography",value:"攝影","onUpdate:modelValue":e[3]||(e[3]=o=>d.value=o)},null,512),[[N,d.value]]),e[8]||(e[8]=s("label",{class:"form-check-label",for:"photography"}," 攝影 ",-1))])])]),s("div",fe,[e[10]||(e[10]=s("label",{class:"form-label"},"上傳圖片",-1)),s("input",{type:"file",class:"form-control",onChange:T,accept:"image/*"},null,32)]),u.value?(R(),W("div",pe,[e[11]||(e[11]=s("label",{class:"form-label"},"圖片左右位置調整",-1)),s("div",ve,[M(s("input",{type:"range",class:"form-range flex-grow-1",min:"-50",max:"50",step:"1","onUpdate:modelValue":e[4]||(e[4]=o=>h.value=o)},null,512),[[S,h.value,void 0,{number:!0}]])]),e[12]||(e[12]=s("small",{class:"form-text text-muted"},"向左拖動向左移動圖片，向右拖動向右移動圖片",-1))])):q("",!0),s("button",{class:"btn btn-primary w-100 btn-lg",onClick:I},e[13]||(e[13]=[s("i",{class:"fas fa-download me-2"},null,-1),j("下載圖片 ")]))])])]),s("div",we,[s("div",be,[s("div",ye,[e[15]||(e[15]=s("h5",{class:"card-title mb-3"},"圖片預覽",-1)),s("div",Ce,[G(ae,{ref_key:"ImageCaptureRef",ref:p,title:r.value,subtitle:k.value,image:u.value,"image-offset-x":h.value,category:d.value,onCanvasClick:E},null,8,["title","subtitle","image","image-offset-x","category"])])])])])]),x.value?(R(),W("div",_e,[s("div",ke,[s("canvas",{ref_key:"modalCanvas",ref:v,class:"img-fluid",onClick:t,style:{cursor:"pointer","max-width":"90vw","max-height":"90vh"}},null,512)])])):q("",!0)]))}}),Te=F(xe,[["__scopeId","data-v-cee742a5"]]),Re=B({__name:"CardMaker",setup(A){return(p,r)=>(R(),Z(ee,{title:"預定圖製作器",content:Te,"is-component":!0,"force-visible":!0}))}});export{Re as default};
